<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
    <%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
        <%@ taglib prefix="cs" uri="futuretense_cs/ftcs1_0.tld" %>
            <%@ taglib prefix="ics" uri="futuretense_cs/ics.tld" %>
                <%@ taglib prefix="render" uri="futuretense_cs/render.tld" %>
                    <%@ taglib prefix="fragment" uri="futuretense_cs/fragment.tld" %>
                        <cs:ftcs>
                            <%-- Modulo/BeneficiosBuscadorListasTemplate --%>
                                <%-- Record dependencies for the Template --%>
                                    <ics:if condition='<%=ics.GetVar("tid")!=null%>'>
                                        <ics:then>
                                            <render:logdep cid='<%=ics.GetVar("tid")%>' c="Template" />
                                        </ics:then>
                                    </ics:if>
                                    <c:if test='${not empty asset.Titulo or not empty asset.Imagen}'>
                                        <section class="mc-banner-beneficios section-beneficios" id="page-header">
                                            <c:if test='${empty asset.Titulo}'>
                                                <div class="row" id="main-title">
                                                    <h1 class="TituloLista"></h1>

                                                </div>
                                            </c:if>
                                            <c:if test='${not empty asset.Titulo}'>
                                                <div class="row" id="main-title">
                                                    <h1>${asset.Titulo}</h1>
                                                    <a href="#"><i><img src="/imagen/map-marker-blue.png" alt=""></i>
                                                        ${asset.Subtitulo} </a>
                                                </div>
                                            </c:if>
                                            <c:if test='${not empty asset.Imagen}'>
                                                <div class="banner-header <c:if test='${!empty asset.Titulo}'>no-margin</c:if>"
                                                    style="background-image: url('${imagen_asset.ImagenContainer_bloblink_}')">
                                                </div>
                                            </c:if>
                                        </section>
                                    </c:if>
                                    <!-- ***********   BUSCADOR     ***********  -->
                                    <style>
                                        .ui-menu {
                                            max-height: 300px;
                                            overflow-y: auto;
                                            overflow-x: hidden;
                                        }
                                    </style>
                                    <section class="section-beneficios" id="buscador-beneficios">
                                        <div class="container">
                                            <form class="row" action="javascript:sendForm()">
                                                <label>
                                                    <!--<input type="text" name="ubicacion" value="" id="ubicacion" />-->
                                                    <select name="ubicacion" id="ubicacion">
                                                        <option value="CAPITAL FEDERAL">CAPITAL FEDERAL</option>
                                                        <option value="BUENOS AIRES">BUENOS AIRES</option>
                                                        <option value="CATAMARCA">CATAMARCA</option>
                                                        <option value="CHACO">CHACO</option>
                                                        <option value="CHUBUT">CHUBUT</option>
                                                        <option value="CORDOBA">CORDOBA</option>
                                                        <option value="CORRIENTES">CORRIENTES</option>
                                                        <option value="ENTRE RIOS">ENTRE RIOS</option>
                                                        <option value="FORMOSA">FORMOSA</option>
                                                        <option value="JUJUY">JUJUY</option>
                                                        <option value="LA PAMPA">LA PAMPA</option>
                                                        <option value="LA RIOJA">LA RIOJA</option>
                                                        <option value="MENDOZA">MENDOZA</option>
                                                        <option value="MISIONES">MISIONES</option>
                                                        <option value="NEUQUEN">NEUQUEN</option>
                                                        <option value="RIO NEGRO">RIO NEGRO</option>
                                                        <option value="SALTA">SALTA</option>
                                                        <option value="SAN JUAN">SAN JUAN</option>
                                                        <option value="SAN LUIS">SAN LUIS</option>
                                                        <option value="SANTA CRUZ">SANTA CRUZ</option>
                                                        <option value="SANTA FE">SANTA FE</option>
                                                        <option value="SANTIAGO DEL ESTERO">SANTIAGO DEL ESTERO</option>
                                                        <option value="TIERRA DEL FUEGO">TIERRA DEL FUEGO</option>
                                                        <option value="TUCUMAN">TUCUMAN</option>
                                                    </select>
                                                </label>
                                                <label>
                                                    <select name="categoria" id="categoria">
                                                        <c:forEach items="${asset.LabelsCamposBusqueda}" var="items"
                                                            varStatus="loop">
                                                            <option value="${items}">${items}</option>
                                                        </c:forEach>
                                                    </select>
                                                </label>
                                                <label>
                                                    <input type="text" name="beneficios"
                                                        placeholder="Buscar ahorros y beneficios" id="buscar" />
                                                </label>
                                                <a class="mas-filtros" data-toggle="collapse" href="#mas-filtros"
                                                    role="button" aria-expanded="false" aria-controls="mas-filtros">
                                                    M&Aacute;S FILTROS
                                                    <i><img src="/imagen/filtros.png" alt="Mas filtros"></i>
                                                </a>
                                                <div class="collapse" id="mas-filtros">
                                                    <label><input type="text" name="localidad" placeholder="Localidad"
                                                            value="" id="localidad" /></label>
                                                    <label>
                                                        <select name="dia-semana" id="dia-semana">
                                                            <option value="7">Todos los d&iacute;as</option>
                                                            <option value="8">Hoy</option>
                                                            <option value="1">Lunes </option>
                                                            <option value="2">Martes </option>
                                                            <option value="3">Mi&eacute;rcoles </option>
                                                            <option value="4">Jueves </option>
                                                            <option value="5">Viernes </option>
                                                            <option value="6">S&aacute;bado </option>
                                                            <option value="0">Domingo </option>
                                                        </select>
                                                    </label>
                                                    <label>
                                                        <select name="tarjeta" id="tarjeta">
                                                            <option value="">Todas las Tarjetas</option>
                                                            <option value="TD">Tarjeta de Debito</option>
                                                            <option value="TC">Tarjeta de Cr&eacute;dito</option>
                                                        </select>
                                                    </label>
                                                </div>
                                                <input type="submit" value="Buscar" class="btn bg-color-18" />
                                            </form>
                                        </div>
                                    </section>
                                    <!-- ***********  FIN DE  BUSCADOR       ***********  -->
                                    <!-- ***********   CARDS BENEFICIOS - GRILLA + CARRUSEL     ***********  -->
                                    <section class="section-beneficios" id="main-content beneficios-ppal">
                                        <!--
        <div class="container">
            <c:if test="${not empty asset.Titulo}">
                <div class="row" id="main-title">
                    <h1>${asset.Titulo}</h1>
                    <a href="#"><i><img src="/imagen/map-marker-blue.png" alt="" ></i>  ${asset.Subtitulo} </a>
                </div>
            </c:if>
        </div>
-->
                                        <div id="main-beneficios-container" class="container">
                                            <div id="beneficioswait" class="cards-beneficios d-md-block d-sm-none">
                                                <div class="row">
                                                    <div id="beneficioswaitcard1" class="card card-wait"
                                                        style="width: 15rem;background-color: #eeee;">
                                                        <div class="card-body">
                                                            <div class="card-logo-comercio">
                                                                <img src="/imagen/loading_azul.svg"
                                                                    alt="beneficios-loading"
                                                                    style="max-width:25%;height: 100%;margin-top: 35px;">
                                                            </div>
                                                            <h6 class="card-title" style="margin-top: 71px;"></h6>
                                                            <h5 class="card-title"></h5>
                                                        </div>
                                                    </div>
                                                    <div id="beneficioswaitcard2" class="card card-wait"
                                                        style="width: 15rem;background-color: #eeee;">
                                                        <div class="card-body">
                                                            <div class="card-logo-comercio">
                                                                <img src="/imagen/loading_azul.svg"
                                                                    alt="beneficios-loading"
                                                                    style="max-width:25%;height: 100%;margin-top: 35px;">
                                                            </div>
                                                            <h6 class="card-title" style="margin-top: 71px;"></h6>
                                                            <h5 class="card-title"></h5>
                                                        </div>
                                                    </div>
                                                    <div id="beneficioswaitcard3" class="card card-wait"
                                                        style="width: 15rem;background-color: #eeee;">
                                                        <div class="card-body">
                                                            <div class="card-logo-comercio">
                                                                <img src="/imagen/loading_azul.svg"
                                                                    alt="beneficios-loading"
                                                                    style="max-width:25%;height: 100%;margin-top: 35px;">
                                                            </div>
                                                            <h6 class="card-title" style="margin-top: 71px;"></h6>
                                                            <h5 class="card-title"></h5>
                                                        </div>
                                                    </div>
                                                    <div id="beneficioswaitcard4" class="card card-wait"
                                                        style="width: 15rem;background-color: #eeee;">
                                                        <div class="card-body">
                                                            <div class="card-logo-comercio">
                                                                <img src="/imagen/loading_azul.svg"
                                                                    alt="beneficios-loading"
                                                                    style="max-width:25%;height: 100%;margin-top: 35px;">
                                                            </div>
                                                            <h6 class="card-title" style="margin-top: 71px;"></h6>
                                                            <h5 class="card-title"></h5>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="cards-beneficios mx-auto my-auto d-md-none d-sm-block">
                                                <div id="carousel-beneficios-00"
                                                    class="carousel slide carousel-multi-item carousel-beneficios"
                                                    data-ride="carousel" wrap="true">
                                                    <div class="carousel-inner row w-100 mx-auto">
                                                        <div class="carousel-item active">
                                                            <div class="col-md-3">
                                                                <div id="beneficioswaitcardMobile"
                                                                    class="card card-wait"
                                                                    style="background-color: #eeee;">
                                                                    <div class="card-body">
                                                                        <div class="card-logo-comercio"><img
                                                                                src="/imagen/loading_azul.svg"
                                                                                alt="beneficios-loading"
                                                                                style="max-width:45%; height:50px;">
                                                                        </div>
                                                                        <h6 class="card-title"></h6>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </section>
                                    <!-- ***********    FIN CARDS BENEFICIOS - GRILLA + CARRUSEL       ***********  -->
                                    <script defer>
                                        //Inicializa Valiables de servicios
                                        urlServicios.url_servicio_categoria = "${asset.url_categorias}";
                                        urlServicios.url_servicio_logo = "${asset.url_logo}";
                                        urlServicios.url_servicio_localidades = "${asset.url_localidades}";
                                        urlServicios.url_servicio_predictivo = "${asset.URLAutocomplete}";
                                        urlServicios.url_servicio_client_id = "${asset.Endpoint_ClientID}";
                                        urlServicios.url_servicio_promociones_lista = "${asset.url_Beneficios}?idLista=";
                                        urlServicios.url_endpoint = "${asset.urlExterna}";
                                        //Setea un default
                                        if (provinciaActual == null) {
                                            setProvincia('BuenosAires');
                                        }
                                        // Obtiene id de lista
                                        let id_servicio_lista = "${asset.lista}";
                                        //Obtiene id de lista por parametro en URL (Solo si esta vacia en la contribución)
                                        if (id_servicio_lista == "" || id_servicio_lista == undefined) {
                                            if (validateParams().is) {
                                                id_servicio_lista = validateParams().params.get("idLista");
                                            }
                                        }

                                        //valida si se pasa filtro de categoria por parametro
                                        let getListFilters = () => {
                                            if (validateParams().is) {
                                                if (typeof (validateParams().params.get("categoria")) !== "undefined" && validateParams().params.get("categoria") !== null) {
                                                    return { is: true, params: { categoria: validateParams().params.get("categoria") } };
                                                } else {
                                                    return { is: false };
                                                }
                                            } else {
                                                return { is: false };
                                            }
                                        }

                                        // Inserta Categorias en combo 
                                        let insertaCategorias = (data) => {
                                            let categorias = $('#categoria');
                                            let principal = "", secundarias = "";
                                            let urlParams = validateParams();
                                            if (urlParams.is) {
                                                secundarias += ('<option value="All">Todos los rubros</option>');
                                                for (let i in data) {
                                                    if (data[i].displayName == urlParams.params.get("categoria")) {
                                                        principal += '<option value="' + data[i].displayName + '">' + data[i].displayName + '</option>';
                                                    } else {
                                                        secundarias += '<option value="' + data[i].displayName + '">' + data[i].displayName + '</option>';
                                                    }
                                                }
                                            } else {
                                                principal += ('<option value="All">Todos los rubros</option>');
                                                for (let i in data) {
                                                    secundarias += '<option value="' + data[i].displayName + '">' + data[i].displayName + '</option>';
                                                }
                                            }
                                            categorias.empty();
                                            categorias.append(principal + secundarias);
                                        }
                                        //Se ejecuta en pagina de resultados
                                        let sendForm = () => {
                                            let filters = {
                                                is: true,
                                                params: {
                                                    categoria: $("#categoria").val(),
                                                    beneficios: $("#buscar").val(),
                                                    localidad: $("#localidad").val(),
                                                    dia: $("#dia-semana").val(),
                                                    tarjeta: $("#tarjeta").val()
                                                }
                                            }
                                            urlServicios.url_servicio_promociones_lista = "${asset.url_Beneficios}?idLista=";
                                            initBeneficiosLista("main-beneficios-container", id_servicio_lista, filters);
                                        }
                                        //Obtiene Categorias
                                        getCategorias().then(res => { return categorias = res; });
                                        //Obtiene Localidades por provincia
                                        getLocalidades().then(res => { return localidades = res; });
                                        //Ejecuta Inserta Categorias
                                        insertaCategorias(categorias);
                                        // Inserta Ubicación Actual
                                        $("#ubicacion").val(provinciaActual.provinceNeutral);
                                        // Inserta Pedicitivo Provincias
                                        /*$('#ubicacion').autocomplete({
                                            source: getProvincias()
                                        });*/
                                        // Inserta Predictivo Localidades
                                        $("#localidad").autocomplete({
                                            source: getLocalidadName()
                                        });
                                        //Inserta Predictivo Beneficios
                                        $("#buscar").autocomplete({
                                            source: (request, response) => {
                                                let url = urlServicios.url_servicio_predictivo + $("#buscar").val() + "&province=" + provinciaActual.provinceIsoCode;
                                                $.ajax({
                                                    "async": true,
                                                    "crossDomain": true,
                                                    "url": url,
                                                    "method": "GET",
                                                    "headers": {
                                                        "Accept": "application/json",
                                                        "Cache-Control": "no-cache",
                                                        "x-ibm-client-id": urlServicios.url_servicio_client_id
                                                    }
                                                }).done(function (data) {
                                                    response(data);
                                                });
                                            }
                                        });
                                        $('#ubicacion').change(() => {
                                            setProvincia(getProvinciaKey($("#ubicacion").val()));
                                            getLocalidades().then(res => { return localidades = res; });
                                            if ($('.location span').length > 0) {
                                                try {
                                                    $('.location span').text($("#ubicacion").val());
                                                } catch (e) { }
                                            }
                                            $("#localidad").autocomplete({
                                                source: getLocalidadName()
                                            });
                                            $("#buscar").val("");
                                            $("#buscar").autocomplete({
                                                source: (request, response) => {
                                                    let url = urlServicios.url_servicio_predictivo + $("#buscar").val() + "&province=" + provinciaActual.provinceIsoCode;
                                                    $.ajax({
                                                        "async": true,
                                                        "crossDomain": true,
                                                        "url": url,
                                                        "method": "GET",
                                                        "headers": {
                                                            "Accept": "application/json",
                                                            "Cache-Control": "no-cache",
                                                            "x-ibm-client-id": urlServicios.url_servicio_client_id
                                                        }
                                                    }).done(function (data) {
                                                        response(data);
                                                    });
                                                }
                                            });
                                        });
                                        // Inicializa Servicio Lista 
                                        geoPageCallback(initBeneficiosLista, "main-beneficios-container", id_servicio_lista, getListFilters());
                                        function location_realized() {
                                            geoPageCallback(initBeneficiosLista, "main-beneficios-container", id_servicio_lista, getListFilters());
                                        }
                                    </script>
                        </cs:ftcs>